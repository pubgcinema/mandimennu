<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Cinema Mandi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <div class="container checkout-container mt-5">
        <div class="logo-container text-center mb-4">
            <img src="../Images/cm logo.jpg" alt="Cinema Mandi Logo" class="img-fluid" style="height: 100px;">
        </div>

        <h2 class="text-center mb-4">Place Your Order</h2>

        <form id="checkout-form">
            <div class="formVigorous form-group mb-3">
                <label for="table-name" class="form-label">Select Your Table</label>
                <select id="table-name" name="table-name" class="form-select" required>
                    <option value="">-- Choose a Table --</option>
                    <option value="World of Khansar">World of Khansar</option>
                    <option value="Brindavanam">Brindavanam</option>
                    <option value="Ala Vaikunthapurramuloo">Ala Vaikunthapurramuloo</option>
                    <option value="Rangasthalam">Rangasthalam</option>
                    <option value="Sye">Sye</option>
                    <option value="Baahubali">Baahubali</option>
                </select>
            </div>

            <div class="cart-summary mb-4">
                <h3>Your Cart:</h3>
                <ul id="cart-items" class="list-group mb-3"></ul>
                <p class="total-price"><strong>Total Price: ₹<span id="total-price">0.00</span></strong></p>
            </div>

            <button type="submit" id="place-order-btn" class="btn btn-success w-100">Place Order</button>
        </form>

        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cartItemsContainer = document.getElementById('cart-items');
            const totalPriceElement = document.getElementById('total-price');
            const placeOrderBtn = document.getElementById('place-order-btn');
            const checkoutForm = document.getElementById('checkout-form');

            function loadCart() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                cartItemsContainer.innerHTML = '';
                let total = 0;

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<li class="list-group-item">Your cart is empty.</li>';
                } else {
                    cart.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between';
                        li.innerHTML = `${item.name} x ${item.quantity} <span>₹${(item.price * item.quantity).toFixed(2)}</span>`;
                        cartItemsContainer.appendChild(li);
                        total += item.price * item.quantity;
                    });
                }

                totalPriceElement.textContent = total.toFixed(2);
            }

            function clearCart() {
                localStorage.removeItem('cart');
            }

            //  Helper function to properly encode the cart details
            function encodeCartDetails(cart) {
                return cart.map(item => `${item.name} x ${item.quantity}`).join('%0A'); //  Newline for each item
            }

            checkoutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const tableName = document.getElementById('table-name').value.trim();
                const cart = JSON.parse(localStorage.getItem('cart')) || [];

                if (tableName === '') {
                    alert('Please select your table.');
                    return;
                }
                if (cart.length === 0) {
                    alert('Your cart is empty.');
                    return;
                }

                const cartDetails = encodeCartDetails(cart);
                const totalPrice = totalPriceElement.textContent;

                placeOrderBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Placing Order...';
                placeOrderBtn.disabled = true;

                //  *IMPORTANT*:  Use the /formResponse URL, NOT the /viewform URL from the prefilled link!
                const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSd8I2e8PDH1-ADFWT5sseYevr08NWBdcjwzc_e4SLlQdyh_Ng/formResponse';
                const TABLE_FIELD_ID = 'entry.1798445360';  //  *CONFIRMED FROM PREFILLED LINK*
                const CART_FIELD_ID = 'entry.1384167702';   //  *CONFIRMED FROM PREFILLED LINK*
                const TOTAL_FIELD_ID = 'entry.1053291576';   //  *CONFIRMED FROM PREFILLED LINK*

                const formData = new FormData();
                formData.append(TABLE_FIELD_ID, tableName);
                formData.append(CART_FIELD_ID, cartDetails);
                formData.append(TOTAL_FIELD_ID, totalPrice);

                try {
                    await fetch(GOOGLE_FORM_URL, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors'
                    });

                    alert('Order placed successfully!');
                    clearCart();
                    window.location.href = '../index.html';
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('Failed to place order. Please try again later.');
                    placeOrderBtn.innerHTML = 'Place Order';
                    placeOrderBtn.disabled = false;
                }
            });

            loadCart();
        });
    </script>
</body>

</html>